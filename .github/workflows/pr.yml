name: PR Checks

on:
  pull_request:
    branches: [master, main, staging]
    types: [opened, synchronize, reopened]

jobs:
  test-and-lint:
    name: Test, Coverage & Lint
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode.app
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Find available iOS Simulator
        id: find_simulator
        run: |
          # List available iOS simulators and get the first available one
          # Format: "iPhone 16 (45C6D5EF-1FB3-4EB2-B558-33B503ED371E) (Booted)" or "iPhone 16 (45C6D5EF-1FB3-4EB2-B558-33B503ED371E) (Shutdown)"
          SIMULATOR_UDID=$(xcrun simctl list devices available | grep -i "iPhone" | grep -v "unavailable" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          if [ -z "$SIMULATOR_UDID" ]; then
            # Fallback: get any iOS simulator
            SIMULATOR_UDID=$(xcrun simctl list devices available | grep -i "iOS" | grep -v "unavailable" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          fi
          if [ -z "$SIMULATOR_UDID" ]; then
            echo "‚ùå No iOS simulator found"
            xcrun simctl list devices available
            exit 1
          fi
          echo "simulator_udid=${SIMULATOR_UDID}" >> $GITHUB_OUTPUT
          echo "‚úÖ Found simulator UDID: ${SIMULATOR_UDID}"
      
      - name: Boot simulator if needed
        run: |
          BOOT_STATUS=$(xcrun simctl list devices | grep "${{ steps.find_simulator.outputs.simulator_udid }}" | grep -o "(Booted)" || echo "")
          if [ -z "$BOOT_STATUS" ]; then
            echo "Booting simulator ${{ steps.find_simulator.outputs.simulator_udid }}"
            xcrun simctl boot "${{ steps.find_simulator.outputs.simulator_udid }}" || true
          else
            echo "Simulator ${{ steps.find_simulator.outputs.simulator_udid }} is already booted"
          fi
      
      - name: Run unit tests with coverage
        run: |
          xcodebuild test \
            -project bidding-mobile-ios-sdk.xcodeproj \
            -scheme bidding-mobile-ios-sdk \
            -destination "platform=iOS Simulator,id=${{ steps.find_simulator.outputs.simulator_udid }}" \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult || true
      
      - name: Generate coverage report
        run: |
          xcrun xccov view --report --only-targets TestResults.xcresult > coverage.txt || echo "Coverage report generation failed"
      
      - name: Run SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --reporter github-actions-logging
        continue-on-error: true
        id: swiftlint
      
      - name: Get SwiftLint results
        if: steps.swiftlint.outcome == 'failure'
        run: |
          swiftlint lint --reporter github-actions-logging > swiftlint-results.txt 2>&1 || true
      
      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { readFileSync } = require('fs');
            
            let comment = '## üìä Test & Quality Report\n\n';
            
            // Test results
            if (fs.existsSync('test-report.html')) {
              comment += '### ‚úÖ Tests\n';
              comment += 'Unit tests completed. Check the [test report](artifact://test-report.html) for details.\n\n';
            } else {
              comment += '### ‚ö†Ô∏è Tests\n';
              comment += 'Test report not available.\n\n';
            }
            
            // Coverage
            if (fs.existsSync('coverage.txt')) {
              const coverage = readFileSync('coverage.txt', 'utf8');
              comment += '### üìà Code Coverage\n';
              comment += '```\n' + coverage.substring(0, 500) + '\n```\n\n';
            } else {
              comment += '### ‚ö†Ô∏è Coverage\n';
              comment += 'Coverage report not available.\n\n';
            }
            
            // SwiftLint
            if (fs.existsSync('swiftlint-results.txt')) {
              const lintResults = readFileSync('swiftlint-results.txt', 'utf8');
              if (lintResults.trim().length > 0) {
                comment += '### ‚ö†Ô∏è SwiftLint Issues\n';
                comment += '<details><summary>Click to expand</summary>\n\n';
                comment += '```\n' + lintResults.substring(0, 2000) + '\n```\n';
                comment += '</details>\n\n';
              } else {
                comment += '### ‚úÖ SwiftLint\n';
                comment += 'No linting issues found.\n\n';
              }
            } else {
              comment += '### ‚úÖ SwiftLint\n';
              comment += 'Lint check passed.\n\n';
            }
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Test & Quality Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            TestResults.xcresult
            test-report.html
            coverage.txt
            swiftlint-results.txt
          retention-days: 7

