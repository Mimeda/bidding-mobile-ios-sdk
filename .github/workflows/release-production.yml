name: Production Release

on:
  push:
    branches: [master, main]

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract version from SDKConfig
        id: version
        run: |
          VERSION=$(grep -o 'static let sdkVersion = "[^"]*"' bidding-mobile-ios-sdk/SDKConfig.swift | cut -d'"' -f2)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "üì¶ Version: ${VERSION}"
          echo "üè∑Ô∏è  Tag: v${VERSION}"
      
      - name: Check if tag exists in private repo (duplicate version check)
        id: check_tag_private
        run: |
          if git rev-parse "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
            echo "‚ùå ERROR: Duplicate version detected in private repository!"
            echo "Tag ${{ steps.version.outputs.tag }} already exists in the repository."
            echo "Please update the version in SDKConfig.swift before creating a new release."
            exit 1
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag ${{ steps.version.outputs.tag }} does not exist in private repo - proceeding with release"
          fi
      
      - name: Check if tag exists in public repo (duplicate version check)
        id: check_tag_public
        run: |
          if git ls-remote --tags https://${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/Mimeda/bidding-mobile-ios-sdk-release.git | grep -q "refs/tags/${{ steps.version.outputs.tag }}$"; then
            echo "‚ùå ERROR: Duplicate version detected in public repository!"
            echo "Tag ${{ steps.version.outputs.tag }} already exists in the public repository."
            echo "Please update the version in SDKConfig.swift before creating a new release."
            exit 1
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag ${{ steps.version.outputs.tag }} does not exist in public repo - proceeding with release"
          fi
      
      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode.app
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: List available simulators
        run: |
          echo "Available simulators:"
          xcrun simctl list devices available | grep -i "iPhone" | head -5
      
      - name: Boot iOS Simulator
        run: |
          # Find first available iPhone simulator
          SIMULATOR_UDID=$(xcrun simctl list devices available | grep -i "iPhone" | grep -v "unavailable" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          if [ -z "$SIMULATOR_UDID" ]; then
            echo "‚ùå No iPhone simulator found in available devices"
            xcrun simctl list devices available
            exit 1
          fi
          echo "SIMULATOR_UDID=${SIMULATOR_UDID}" >> $GITHUB_ENV
          echo "‚úÖ Found simulator UDID: ${SIMULATOR_UDID}"
          
          # Boot the simulator
          echo "Booting simulator..."
          xcrun simctl boot "$SIMULATOR_UDID" 2>&1 || echo "Simulator may already be booted"
          
          # Wait a bit for simulator to be ready
          sleep 5
      
      - name: Find simulator in xcodebuild destinations
        id: find_simulator
        run: |
          # Now get destinations from xcodebuild - should include the booted simulator
          DEST_LINE=$(xcodebuild -showdestinations -project bidding-mobile-ios-sdk.xcodeproj -scheme bidding-mobile-ios-sdk 2>&1 | grep "platform:iOS Simulator" | grep "iPhone" | grep -v "placeholder" | head -1)
          if [ -z "$DEST_LINE" ]; then
            # Fallback: get any iOS Simulator (not placeholder)
            DEST_LINE=$(xcodebuild -showdestinations -project bidding-mobile-ios-sdk.xcodeproj -scheme bidding-mobile-ios-sdk 2>&1 | grep "platform:iOS Simulator" | grep -v "placeholder" | head -1)
          fi
          if [ -z "$DEST_LINE" ]; then
            echo "‚ö†Ô∏è No simulator in xcodebuild destinations, using UDID from simctl"
            # Use the UDID we found earlier
            SIMULATOR_ID="${{ env.SIMULATOR_UDID }}"
          else
            # Extract ID from destination line
            SIMULATOR_ID=$(echo "$DEST_LINE" | awk -F'id:' '{print $2}' | awk -F',' '{print $1}' | tr -d ' ')
          fi
          
          if [ -z "$SIMULATOR_ID" ] || [ "$SIMULATOR_ID" = "dvtdevice-DVTiOSDeviceSimulatorPlaceholder-iphonesimulator:placeholder" ]; then
            echo "‚ùå Could not extract valid simulator ID"
            exit 1
          fi
          echo "simulator_id=${SIMULATOR_ID}" >> $GITHUB_OUTPUT
          echo "‚úÖ Using simulator ID: ${SIMULATOR_ID}"
          echo "Destination line: $DEST_LINE"
      
      - name: Run tests
        run: |
          xcodebuild test \
            -project bidding-mobile-ios-sdk.xcodeproj \
            -scheme bidding-mobile-ios-sdk \
            -destination "platform=iOS Simulator,id=${{ steps.find_simulator.outputs.simulator_id }}" || exit 1
      
      - name: Build XCFramework
        run: |
          chmod +x Scripts/build-xcframework.sh
          Scripts/build-xcframework.sh
      
      - name: Verify XCFramework
        run: |
          if [ ! -f "bidding_mobile_ios_sdk.xcframework.zip" ]; then
            echo "‚ùå XCFramework ZIP not found!"
            exit 1
          fi
          echo "‚úÖ XCFramework created successfully"
          ls -lh bidding_mobile_ios_sdk.xcframework.zip
      
      - name: Calculate XCFramework checksum
        id: checksum
        run: |
          CHECKSUM=$(swift package compute-checksum bidding_mobile_ios_sdk.xcframework.zip)
          echo "checksum=${CHECKSUM}" >> $GITHUB_OUTPUT
          echo "‚úÖ Checksum calculated: ${CHECKSUM}"
      
      - name: Create binary Package.swift for public repo
        run: |
          cat > Package.swift << EOF
          // swift-tools-version: 5.7
          // The swift-tools-version declares the minimum version of Swift required to build this package.
          
          import PackageDescription
          
          let package = Package(
              name: "bidding-mobile-ios-sdk",
              platforms: [
                  .iOS(.v13)
              ],
              products: [
                  .library(
                      name: "bidding-mobile-ios-sdk",
                      targets: ["bidding-mobile-ios-sdk"]
                  ),
              ],
              dependencies: [],
              targets: [
                  .binaryTarget(
                      name: "bidding-mobile-ios-sdk",
                      url: "https://github.com/Mimeda/bidding-mobile-ios-sdk-release/releases/download/${{ steps.version.outputs.tag }}/bidding_mobile_ios_sdk.xcframework.zip",
                      checksum: "${{ steps.checksum.outputs.checksum }}"
                  ),
              ]
          )
          EOF
          echo "‚úÖ Binary Package.swift created with checksum"
          cat Package.swift
      
      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"
      
      - name: Push binary Package.swift to public repo
        run: |
          # Clone public repo to a temporary directory
          TEMP_DIR=$(mktemp -d)
          git clone https://${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/Mimeda/bidding-mobile-ios-sdk-release.git "$TEMP_DIR"
          cd "$TEMP_DIR"
          
          # Copy binary Package.swift (XCFramework will be uploaded as release asset only)
          cp "${{ github.workspace }}/Package.swift" .
          
          # Commit and push to main/master branch first
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main 2>/dev/null || git checkout master
          git add Package.swift
          git commit -m "Update Package.swift for ${{ steps.version.outputs.tag }}" || echo "No changes to commit"
          git push origin HEAD || echo "Push may have failed or no changes"
          
          # Now create tag on this commit
          if ! git rev-parse "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
            git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
            git push origin "${{ steps.version.outputs.tag }}"
            echo "‚úÖ Tag ${{ steps.version.outputs.tag }} created and pushed to public repo"
            
            # Verify tag points to current commit
            CURRENT_COMMIT=$(git rev-parse HEAD)
            TAG_COMMIT=$(git rev-parse "${{ steps.version.outputs.tag }}")
            if [ "$CURRENT_COMMIT" = "$TAG_COMMIT" ]; then
              echo "‚úÖ Tag points to correct commit: $CURRENT_COMMIT"
            else
              echo "‚ö†Ô∏è Warning: Tag points to different commit. Current: $CURRENT_COMMIT, Tag: $TAG_COMMIT"
            fi
          else
            echo "‚ö†Ô∏è Tag ${{ steps.version.outputs.tag }} already exists"
            # Verify existing tag points to current commit
            CURRENT_COMMIT=$(git rev-parse HEAD)
            TAG_COMMIT=$(git rev-parse "${{ steps.version.outputs.tag }}" 2>/dev/null || echo "")
            if [ -n "$TAG_COMMIT" ] && [ "$CURRENT_COMMIT" = "$TAG_COMMIT" ]; then
              echo "‚úÖ Existing tag points to correct commit: $CURRENT_COMMIT"
            elif [ -n "$TAG_COMMIT" ]; then
              echo "‚ö†Ô∏è Warning: Existing tag points to different commit. Current: $CURRENT_COMMIT, Tag: $TAG_COMMIT"
            fi
          fi
          
          # Cleanup
          cd "${{ github.workspace }}"
          rm -rf "$TEMP_DIR"
          echo "‚úÖ Package.swift pushed to public repo with tag"
      
      - name: Create GitHub Release (Private Repo)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## Release ${{ steps.version.outputs.tag }}
            
            ### üì¶ Package
            - **XCFramework**: `bidding_mobile_ios_sdk.xcframework.zip`
            
            ### üìù Installation
            ```swift
            dependencies: [
                .package(url: "https://github.com/Mimeda/bidding-mobile-ios-sdk-release.git", from: "${{ steps.version.outputs.version }}")
            ]
            ```
            
            ### üîó Public Release
            This release is also available in the [public repository](https://github.com/Mimeda/bidding-mobile-ios-sdk-release/releases/tag/${{ steps.version.outputs.tag }}).
          files: |
            bidding_mobile_ios_sdk.xcframework.zip
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check if public repo has commits
        id: check_public_repo
        run: |
          # Check if public repository has any commits
          if git ls-remote --heads --tags https://${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/Mimeda/bidding-mobile-ios-sdk-release.git | grep -q .; then
            echo "has_commits=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Public repository has commits"
          else
            echo "has_commits=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Public repository is empty - release creation may fail"
          fi
      
      - name: Upload to Public Repo
        if: steps.check_public_repo.outputs.has_commits == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## Release ${{ steps.version.outputs.tag }}
            
            ### üì¶ Package
            - **XCFramework**: `bidding_mobile_ios_sdk.xcframework.zip`
            
            ### üìù Installation
            ```swift
            dependencies: [
                .package(url: "https://github.com/Mimeda/bidding-mobile-ios-sdk-release.git", from: "${{ steps.version.outputs.version }}")
            ]
            ```
          files: |
            bidding_mobile_ios_sdk.xcframework.zip
          draft: false
          prerelease: false
          repository: Mimeda/bidding-mobile-ios-sdk-release
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
      
      - name: Warn if public repo is empty
        if: steps.check_public_repo.outputs.has_commits == 'false'
        run: |
          echo "‚ö†Ô∏è Public repository is empty. Please create at least one commit in the public repository before creating releases."
          echo "Tag has been pushed to public repository, but release creation was skipped."

