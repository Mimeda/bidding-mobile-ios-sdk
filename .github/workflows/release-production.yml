name: Production Release

on:
  push:
    branches: [master, main]

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode.app
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Extract version from SDKConfig
        id: version
        run: |
          VERSION=$(grep -o 'static let sdkVersion = "[^"]*"' bidding-mobile-ios-sdk/SDKConfig.swift | cut -d'"' -f2)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "üì¶ Version: ${VERSION}"
          echo "üè∑Ô∏è  Tag: v${VERSION}"
      
      - name: Find available iOS Simulator
        id: find_simulator
        run: |
          # List available iOS simulators and get the first available one
          # Format: "iPhone 16 (45C6D5EF-1FB3-4EB2-B558-33B503ED371E) (Booted)" or "iPhone 16 (45C6D5EF-1FB3-4EB2-B558-33B503ED371E) (Shutdown)"
          SIMULATOR_UDID=$(xcrun simctl list devices available | grep -i "iPhone" | grep -v "unavailable" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          if [ -z "$SIMULATOR_UDID" ]; then
            # Fallback: get any iOS simulator
            SIMULATOR_UDID=$(xcrun simctl list devices available | grep -i "iOS" | grep -v "unavailable" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          fi
          if [ -z "$SIMULATOR_UDID" ]; then
            echo "‚ùå No iOS simulator found"
            xcrun simctl list devices available
            exit 1
          fi
          echo "simulator_udid=${SIMULATOR_UDID}" >> $GITHUB_OUTPUT
          echo "‚úÖ Found simulator UDID: ${SIMULATOR_UDID}"
      
      - name: Boot simulator if needed
        run: |
          BOOT_STATUS=$(xcrun simctl list devices | grep "${{ steps.find_simulator.outputs.simulator_udid }}" | grep -o "(Booted)" || echo "")
          if [ -z "$BOOT_STATUS" ]; then
            echo "Booting simulator ${{ steps.find_simulator.outputs.simulator_udid }}"
            xcrun simctl boot "${{ steps.find_simulator.outputs.simulator_udid }}" || true
          else
            echo "Simulator ${{ steps.find_simulator.outputs.simulator_udid }} is already booted"
          fi
      
      - name: Run tests
        run: |
          xcodebuild test \
            -project bidding-mobile-ios-sdk.xcodeproj \
            -scheme bidding-mobile-ios-sdk \
            -destination "platform=iOS Simulator,id=${{ steps.find_simulator.outputs.simulator_udid }}" || exit 1
      
      - name: Build XCFramework
        run: |
          chmod +x Scripts/build-xcframework.sh
          Scripts/build-xcframework.sh
      
      - name: Verify XCFramework
        run: |
          if [ ! -f "bidding_mobile_ios_sdk.xcframework.zip" ]; then
            echo "‚ùå XCFramework ZIP not found!"
            exit 1
          fi
          echo "‚úÖ XCFramework created successfully"
          ls -lh bidding_mobile_ios_sdk.xcframework.zip
      
      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Tag ${{ steps.version.outputs.tag }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag ${{ steps.version.outputs.tag }} does not exist"
          fi
      
      - name: Create tag if not exists
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"
      
      - name: Create GitHub Release (Private Repo)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## Release ${{ steps.version.outputs.tag }}
            
            ### üì¶ Package
            - **XCFramework**: `bidding_mobile_ios_sdk.xcframework.zip`
            
            ### üìù Installation
            ```swift
            dependencies: [
                .package(url: "https://github.com/Mimeda/bidding-mobile-ios-sdk-release.git", from: "${{ steps.version.outputs.version }}")
            ]
            ```
            
            ### üîó Public Release
            This release is also available in the [public repository](https://github.com/Mimeda/bidding-mobile-ios-sdk-release/releases/tag/${{ steps.version.outputs.tag }}).
          files: |
            bidding_mobile_ios_sdk.xcframework.zip
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to Public Repo
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## Release ${{ steps.version.outputs.tag }}
            
            ### üì¶ Package
            - **XCFramework**: `bidding_mobile_ios_sdk.xcframework.zip`
            
            ### üìù Installation
            ```swift
            dependencies: [
                .package(url: "https://github.com/Mimeda/bidding-mobile-ios-sdk-release.git", from: "${{ steps.version.outputs.version }}")
            ]
            ```
          files: |
            bidding_mobile_ios_sdk.xcframework.zip
          draft: false
          prerelease: false
          repository: Mimeda/bidding-mobile-ios-sdk-release
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}

